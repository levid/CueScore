// Generated by CoffeeScript 1.3.1
(function() {
  var Game,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor; child.__super__ = parent.prototype; return child; };

  Game = (function(_super) {

    __extends(Game, _super);

    Game.name = 'Game';

    Game.prototype.defaults = {
      stripes: 1,
      solids: 2,
      innings: 0,
      match_ended_callback: function() {},
      number_of_innings: 0,
      ended: false,
      balls_hit_in: {
        stripes: [],
        solids: []
      },
      last_ball_hit_in: null,
      on_break: true,
      breaking_player_still_shooting: true,
      scratch_on_eight: false,
      early_eight: false,
      player: {
        one: {
          eight_ball: [],
          eight_on_snap: false,
          break_and_run: false,
          timeouts_taken: 0,
          callback: function() {},
          ball_type: null,
          has_won: false
        },
        two: {
          eight_ball: [],
          eight_on_snap: false,
          break_and_run: false,
          timeouts_taken: 0,
          callback: function() {},
          ball_type: null,
          has_won: false
        }
      }
    };

    function Game(options) {
      _.extend(this, this.defaults);
      this.player.one.callback = options.addToPlayerOne;
      this.player.two.callback = options.addToPlayerTwo;
      this.match_ended_callback = options.callback;
      this.player.one.callback().timeouts_taken = 0;
      this.player.two.callback().timeouts_taken = 0;
    }

    Game.prototype.getCurrentlyUpPlayer = function() {
      if (this.player.one.callback().currently_up === true) {
        return this.player.one.callback();
      }
      return this.player.two.callback();
    };

    Game.prototype.getWinningPlayer = function() {
      if (this.player.one.has_won === true) {
        return this.player.one;
      } else if (this.player.two.has_won === true) {
        return this.player.two;
      }
    };

    Game.prototype.getWinningPlayerName = function() {
      return this.getWinningPlayer().callback().getFirstNameWithInitials();
    };

    Game.prototype.getBallsHitInByPlayer = function(playerNum) {
      if (playerNum === 1) {
        if (this.player.one.ball_type === this.stripes) {
          return this.balls_hit_in.stripes.concat(this.player.one.eight_ball);
        } else {
          if (this.player.one.ball_type === this.solids) {
            return this.balls_hit_in.solids.concat(this.player.one.eight_ball);
          }
          return [];
        }
      }
      if (playerNum === 2) {
        if (this.player.two.ball_type === this.stripes) {
          return this.balls_hit_in.stripes.concat(this.player.two.eight_ball);
        } else {
          if (this.player.two.ball_type === this.solids) {
            return this.balls_hit_in.solids.concat(this.player.two.eight_ball);
          }
          return [];
        }
      }
    };

    Game.prototype.getGameScore = function() {
      return this.getBallsHitInByPlayer(1).length + "-" + this.getBallsHitInByPlayer(2).length;
    };

    Game.prototype.getBallsHitIn = function() {
      return this.balls_hit_in.solids.concat(this.balls_hit_in.stripes.concat(this.player.two.eight_ball.concat(this.player.one.eight_ball)));
    };

    Game.prototype.getCurrentPlayerRemainingTimeouts = function() {
      if (this.player.one.callback().currently_up === true) {
        return this.player.one.callback().timeouts_allowed - this.player.one.timeouts_taken;
      } else {
        return this.player.two.callback().timeouts_allowed - this.player.two.timeouts_taken;
      }
    };

    Game.prototype.setPlayerWon = function(playerNum) {
      if (playerNum === 1) {
        this.player.one.has_won = true;
        return this.player.one.callback().games_won += 1;
      } else if (playerNum === 2) {
        this.player.two.has_won = true;
        return this.player.two.callback().games_won += 1;
      }
    };

    Game.prototype.setEightOnSnapByPlayer = function(playerNum) {
      if (playerNum === 1) {
        if (this.player.one.eight_on_snap !== true) {
          this.player.one.callback().addToEightOnSnaps(1);
        }
        return this.player.one.eight_on_snap = true;
      } else if (playerNum === 2) {
        if (this.player.two.eight_on_snap !== true) {
          this.player.two.callback().addToEightOnSnaps(1);
        }
        return this.player.two.eight_on_snap = true;
      }
    };

    Game.prototype.setBreakAndRunByPlayer = function(playerNum) {
      if (playerNum === 1) {
        if (this.player.one.break_and_run !== true) {
          this.player.one.callback().addToBreakAndRuns(1);
        }
        return this.player.one.break_and_run = true;
      } else if (playerNum === 2) {
        if (this.player.two.break_and_run !== true) {
          this.player.two.callback().addToBreakAndRuns(1);
        }
        return this.player.two.break_and_run = true;
      }
    };

    Game.prototype.setBallTypeByPlayer = function(playerNum, type) {
      if (playerNum === 1 && type === "stripes") {
        this.player.one.ball_type = this.stripes;
        this.player.two.ball_type = this.solids;
        return this.checkForWinner();
      } else if (playerNum === 2 && type === "stripes") {
        this.player.two.ball_type = this.stripes;
        this.player.one.ball_type = this.solids;
        return this.checkForWinner();
      } else if (playerNum === 1 && type === "solids") {
        this.player.one.ball_type = this.solids;
        this.player.two.ball_type = this.stripes;
        return this.checkForWinner();
      } else if (playerNum === 2 && type === "solids") {
        this.player.two.ball_type = this.solids;
        this.player.one.ball_type = this.stripes;
        return this.checkForWinner();
      }
    };

    Game.prototype.hitSafety = function() {
      this.getCurrentlyUpPlayer().addToSafeties(1);
      return this.nextPlayerIsUp();
    };

    Game.prototype.hitScratchOnEight = function() {
      this.scratch_on_eight = true;
      this.ended = true;
      if (this.player.one.callback().currently_up === true) {
        this.player.two.has_won = true;
        this.player.one.callback().currently_up = false;
        this.player.two.callback().currently_up = true;
      } else {
        this.player.one.has_won = true;
        this.player.two.callback().currently_up = false;
        this.player.one.callback().currently_up = true;
      }
      return this.match_ended_callback();
    };

    Game.prototype.shotMissed = function() {
      return this.nextPlayerIsUp();
    };

    Game.prototype.addToNumberOfInnings = function(num) {
      return this.number_of_innings += num;
    };

    Game.prototype.takeTimeout = function() {
      if (this.getCurrentPlayerRemainingTimeouts() > 0) {
        if (this.player.one.callback().currently_up === true) {
          return this.player.one.timeouts_taken += 1;
        } else {
          return this.player.two.timeouts_taken += 1;
        }
      }
    };

    Game.prototype.breakIsOver = function() {
      return this.on_break = false;
    };

    Game.prototype.end = function() {
      return this.ended = true;
    };

    Game.prototype.scoreBall = function(ballNumber) {
      if (!(this.getBallsHitIn().indexOf(ballNumber) >= 0)) {
        this.last_ball_hit_in = ballNumber;
        if (ballNumber > 0 && ballNumber < 8) {
          this.balls_hit_in.solids.push(ballNumber);
        } else if (ballNumber > 8 && ballNumber < 16) {
          this.balls_hit_in.stripes.push(ballNumber);
        } else {
          if (this.player.one.callback().currently_up === true) {
            this.player.one.eight_ball.push(ballNumber);
          } else {
            if (this.player.two.callback().currently_up === true) {
              this.player.two.eight_ball.push(ballNumber);
            }
          }
          if (this.on_break === true) {
            if (this.balls_hit_in.solids.length !== 7 && this.balls_hit_in.stripes.length !== 7) {
              if (this.player.one.callback().currently_up === true) {
                this.setEightOnSnapByPlayer(1);
              } else {
                if (this.player.two.callback().currently_up === true) {
                  this.setEightOnSnapByPlayer(2);
                }
              }
            }
          } else {
            if (this.balls_hit_in.solids.length !== 7 && this.balls_hit_in.stripes.length !== 7) {
              this.early_eight = true;
              if (this.player.one.callback().currently_up === true) {
                this.player.one.callback().currently_up = false;
                this.player.two.callback().currently_up = true;
              } else if (this.player.two.callback().currently_up === true) {
                this.player.one.callback().currently_up = true;
                this.player.two.callback().currently_up = false;
              }
            }
          }
        }
        return this.checkForWinner();
      }
    };

    Game.prototype.checkForWinner = function() {
      if (this.getBallsHitIn().indexOf(8) >= 0) {
        this.ended = true;
      }
      if (this.ended === true) {
        if (this.breaking_player_still_shooting === true && (this.balls_hit_in.solids.length === 7 || this.balls_hit_in.stripes.length === 7)) {
          if (this.player.one.callback().currently_up === true) {
            this.setBreakAndRunByPlayer(1);
            this.player.one.ball_type = this.solids;
            this.player.two.ball_type = this.stripes;
          } else if (this.player.two.callback().currently_up === true) {
            this.setBreakAndRunByPlayer(2);
            this.player.two.ball_type = this.solids;
            this.player.one.ball_type = this.stripes;
          }
        }
        if (this.player.one.eight_ball.indexOf(8) >= 0 && this.on_break === false) {
          if (this.getBallsHitInByPlayer(1).length !== 8 && this.getBallsHitInByPlayer(2).length !== 8) {
            this.setPlayerWon(2);
          } else if (this.getBallsHitInByPlayer(1).length === 8) {
            this.setPlayerWon(1);
          }
        } else if (this.player.two.eight_ball.indexOf(8) >= 0 && this.on_break === false) {
          if (this.getBallsHitInByPlayer(1).length !== 8 && this.getBallsHitInByPlayer(2).length !== 8) {
            this.setPlayerWon(1);
          } else if (this.getBallsHitInByPlayer(2).length === 8) {
            this.setPlayerWon(2);
          }
        } else {
          if (this.player.one.callback().currently_up === true) {
            this.setPlayerWon(1);
          } else if (this.player.two.callback().currently_up === true) {
            this.setPlayerWon(2);
          }
        }
        return this.match_ended_callback();
      }
    };

    Game.prototype.nextPlayerIsUp = function() {
      if (this.on_break !== true || ((this.player.two.callback().currently_up === true || this.player.one.callback().currently_up === true) && this.getBallsHitIn().length === 0)) {
        if (this.player.one.callback().currently_up === true) {
          this.player.two.callback().currently_up = true;
          this.player.one.callback().currently_up = false;
          if (this.player.one.ball_type == null) {
            if (this.balls_hit_in.solids.length > 0 && this.balls_hit_in.stripes.length === 0) {
              this.player.one.ball_type = this.solids;
              this.player.two.ball_type = this.stripes;
            } else if (this.balls_hit_in.solids.length === 0 && this.balls_hit_in.stripes.length > 0) {
              this.player.one.ball_type = this.stripes;
              this.player.two.ball_type = this.solids;
            }
          }
        } else if (this.player.two.callback().currently_up === true) {
          this.player.two.callback().currently_up = false;
          this.player.one.callback().currently_up = true;
          this.addToNumberOfInnings(1);
          if (this.player.two.ball_type == null) {
            if (this.balls_hit_in.solids.length === 0 && this.balls_hit_in.stripes.length > 0) {
              this.player.one.ball_type = this.solids;
              this.player.two.ball_type = this.stripes;
            } else if (this.balls_hit_in.solids.length > 0 && this.balls_hit_in.stripes.length === 0) {
              this.player.one.ball_type = this.stripes;
              this.player.two.ball_type = this.solids;
            }
          }
        } else {
          this.player.one.callback().currently_up = true;
        }
        this.breaking_player_still_shooting = false;
      }
      return this.on_break = false;
    };

    Game.prototype.toJSON = function() {
      return {
        player_one_timeouts_taken: this.player.one.timeouts_taken,
        player_two_timeouts_taken: this.player.two.timeouts_taken,
        player_one_eight_on_snap: this.player.one.eight_on_snap,
        player_one_break_and_run: this.player.one.break_and_run,
        player_two_eight_on_snap: this.player.two.eight_on_snap,
        player_two_break_and_run: this.player.two.break_and_run,
        player_one_ball_type: this.player.one.ball_type,
        player_two_ball_type: this.player.two.ball_type,
        player_one_eight_ball: this.player.one.eight_ball,
        player_two_eight_ball: this.player.two.eight_ball,
        player_one_won: this.player.one.has_won,
        player_two_won: this.player.two.has_won,
        number_of_innings: this.number_of_innings,
        early_eight: this.early_eight,
        scratch_on_eight: this.scratch_on_eight,
        breaking_player_still_shooting: this.breaking_player_still_shooting,
        striped_balls_hit_in: this.balls_hit_in.stripes,
        solid_balls_hit_in: this.balls_hit_in.solids,
        last_ball_hit_in: this.last_ball_hit_in,
        on_break: this.on_break,
        ended: this.ended
      };
    };

    Game.prototype.fromJSON = function(gameJSON) {
      this.player.one.timeouts_taken = gameJSON.player_one_timeouts_taken;
      this.player.two.timeouts_taken = gameJSON.player_two_timeouts_taken;
      this.player.one.eight_on_snap = gameJSON.player_one_eight_on_snap;
      this.player.one.break_and_run = gameJSON.player_one_break_and_run;
      this.player.two.eight_on_snap = gameJSON.player_two_eight_on_snap;
      this.player.two.break_and_run = gameJSON.player_two_break_and_run;
      this.player.one.ball_type = gameJSON.player_one_ball_type;
      this.player.two.ball_type = gameJSON.player_two_ball_type;
      this.player.one.eight_ball = gameJSON.player_one_eight_ball;
      this.player.two.eight_ball = gameJSON.player_two_eight_ball;
      this.player.one.has_won = gameJSON.player_one_won;
      this.player.two.has_won = gameJSON.player_two_won;
      this.number_of_innings = gameJSON.number_of_innings;
      this.breaking_player_still_shooting = gameJSON.breaking_player_still_shooting;
      this.balls_hit_in.solids = gameJSON.solid_balls_hit_in;
      this.balls_hit_in.stripes = gameJSON.striped_balls_hit_in;
      this.last_ball_hit_in = gameJSON.last_ball_hit_in;
      this.on_break = gameJSON.on_break;
      return this.ended = gameJSON.ended;
    };

    return Game;

  })($CS.Models.EightBall);

  $CS.Models.EightBall.Game = Game;

}).call(this);
